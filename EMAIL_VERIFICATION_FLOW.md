# دليل تدفق التحقق من البريد الإلكتروني

## المشكلة التي تم حلها
عند تسجيل الدخول ببريد إلكتروني غير مؤكد، كان يظهر "Invalid credentials" بدلاً من توجيه المستخدم لصفحة التحقق.

## التغييرات المنجزة

### 1. تحديث SupabaseService.signInWithEmail()

**قبل التحديث:**
```dart
// كان يعطي "Invalid credentials" للبريد غير المؤكد
if (response.user != null) {
  // تسجيل دخول مباشر
} else {
  return {'success': false, 'message': 'Invalid credentials'};
}
```

**بعد التحديث:**
```dart
if (response.user != null) {
  // فحص حالة تأكيد البريد الإلكتروني
  if (response.user!.emailConfirmedAt == null) {
    return {
      'success': false,
      'message': 'Email not verified',
      'email_not_verified': true,
      'email': email,
    };
  }
  // تسجيل دخول عادي
}
```

### 2. تحديث AuthController.signIn()

**قبل التحديث:**
```dart
if (result['success']) {
  // تسجيل دخول ناجح
} else {
  // عرض رسالة خطأ عامة
  Get.snackbar('error', result['message']);
}
```

**بعد التحديث:**
```dart
if (result['success']) {
  // تسجيل دخول ناجح
} else {
  if (result['email_not_verified'] == true) {
    // توجيه لصفحة التحقق
    Get.offAllNamed('/email-verification', 
      arguments: {'email': result['email']});
  } else {
    // عرض رسالة خطأ عادية
    Get.snackbar('error', result['message']);
  }
}
```

### 3. إضافة دالة جديدة

```dart
// دالة لإرسال بريد التحقق للمستخدمين غير المؤكدين
Future<void> sendVerificationForUnverifiedUser(String email) async {
  // التحقق من صحة البريد الإلكتروني
  // إرسال بريد التحقق
  // عرض رسالة نجاح/فشل
}
```

## تدفق العمل الجديد

### 1. تسجيل الدخول ببريد غير مؤكد:
```
المستخدم يدخل البريد وكلمة المرور
    ↓
فحص صحة البيانات
    ↓
فحص حالة تأكيد البريد الإلكتروني
    ↓
إذا كان غير مؤكد:
    ↓
عرض رسالة "البريد الإلكتروني غير مؤكد"
    ↓
التوجيه لصفحة التحقق من البريد الإلكتروني
```

### 2. صفحة التحقق من البريد الإلكتروني:
```
عرض رسالة توضيحية
    ↓
عرض البريد الإلكتروني المستخدم
    ↓
زر "إعادة إرسال بريد التحقق"
    ↓
زر "فحص حالة التحقق"
    ↓
زر "العودة لتسجيل الدخول"
```

## رسائل المستخدم

### رسائل النجاح:
- ✅ "تم تسجيل الدخول بنجاح"
- ✅ "تم إرسال بريد التحقق بنجاح"

### رسائل التحذير:
- ⚠️ "البريد الإلكتروني غير مؤكد"
- ⚠️ "يرجى تأكيد البريد الإلكتروني أولاً"

### رسائل الخطأ:
- ❌ "بيانات الدخول غير صحيحة"
- ❌ "فشل في إرسال بريد التحقق"

## اختبار التدفق

### 1. اختبار البريد غير المؤكد:
1. سجل حساب جديد
2. لا تؤكد البريد الإلكتروني
3. جرب تسجيل الدخول
4. تأكد من التوجيه لصفحة التحقق

### 2. اختبار البريد المؤكد:
1. سجل حساب جديد
2. أكد البريد الإلكتروني
3. جرب تسجيل الدخول
4. تأكد من تسجيل الدخول العادي

### 3. اختبار إعادة إرسال البريد:
1. اذهب لصفحة التحقق
2. اضغط "إعادة إرسال"
3. تحقق من وصول البريد الإلكتروني

## ملاحظات مهمة

1. **تأكد من تفعيل Email Confirmation** في Supabase
2. **تحقق من إعدادات Redirect URLs**
3. **تأكد من وصول البريد الإلكتروني** (تحقق من مجلد Spam)
4. **اختبر على أجهزة حقيقية** وليس فقط المحاكي

## استكشاف الأخطاء

### إذا لم يتم التوجيه لصفحة التحقق:
1. تحقق من logs في Console
2. تأكد من إعدادات Supabase
3. تحقق من حالة البريد الإلكتروني في قاعدة البيانات

### إذا لم يصل البريد الإلكتروني:
1. تحقق من مجلد Spam
2. تأكد من إعدادات SMTP
3. تحقق من إعدادات Email Templates
