# ุฎุทูุงุช ุฅุนุฏุงุฏ ูุธุงู ุงููุดุงุฑูุฉ ูุน Supabase
## ุชุญููู ูุธุงู ุงููุดุงุฑูุฉ ูู Firebase ุฅูู Supabase

---

## ๐ ูุธุฑุฉ ุนุงูุฉ

ูุธุงู ุงููุดุงุฑูุฉ ุงูุฎุงุต ุจู ูุนูู ุญุงููุงู ูุน ุฑูุงุจุท Firebase. ููุชุญููู ุฅูู Supabaseุ ูุญุชุงุฌ ุฅูู:
1. ุฅูุดุงุก ุฌุฏุงูู ูุชุชุจุน ุงููุดุงุฑูุงุช
2. ุฅุนุฏุงุฏ ุฏูุงู ูุณูุงุณุงุช ุงูุฃูุงู
3. ุชุญุฏูุซ ููุฏ Flutter

---

## ๐ฏ ุงูุฎุทูุงุช ุงููุทููุจุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุงูุฎุทูุฉ 1: ุฅูุดุงุก ุฌุฏูู ุงููุดุงุฑูุงุช

ุงูุชุญ **Supabase Dashboard** โ **SQL Editor** โ **New Query**

```sql
-- ุฅูุดุงุก ุฌุฏูู ูุชุชุจุน ุงููุดุงุฑูุงุช
CREATE TABLE public.shares (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    share_type TEXT NOT NULL CHECK (share_type IN ('product', 'vendor')),
    entity_id TEXT NOT NULL,
    user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
    shared_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    device_type TEXT,
    share_method TEXT
);

-- ุงูููุงุฑุณ ููุฃุฏุงุก
CREATE INDEX idx_shares_entity ON public.shares(share_type, entity_id);
CREATE INDEX idx_shares_user ON public.shares(user_id);
CREATE INDEX idx_shares_date ON public.shares(shared_at DESC);
```

### ุงูุฎุทูุฉ 2: ุฅุนุฏุงุฏ ุงูุฃูุงู (RLS)

```sql
-- ุชูุนูู Row Level Security
ALTER TABLE public.shares ENABLE ROW LEVEL SECURITY;

-- ุงูุณูุงุญ ููุฌููุน ุจูุฑุงุกุฉ ุงูุฅุญุตุงุฆูุงุช
CREATE POLICY "Allow public read access"
ON public.shares FOR SELECT TO public USING (true);

-- ุงูุณูุงุญ ูููุณุชุฎุฏููู ุจุฅุถุงูุฉ ูุดุงุฑูุงุช
CREATE POLICY "Allow authenticated insert"
ON public.shares FOR INSERT TO authenticated
WITH CHECK (auth.uid() = user_id OR user_id IS NULL);
```

### ุงูุฎุทูุฉ 3: ุฅูุดุงุก ุฏุงูุฉ ุชุณุฌูู ุงููุดุงุฑูุฉ

```sql
CREATE OR REPLACE FUNCTION public.log_share(
    p_share_type TEXT,
    p_entity_id TEXT,
    p_user_id UUID DEFAULT NULL,
    p_device_type TEXT DEFAULT NULL,
    p_share_method TEXT DEFAULT NULL
)
RETURNS UUID
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_share_id UUID;
BEGIN
    INSERT INTO public.shares (
        share_type,
        entity_id,
        user_id,
        device_type,
        share_method
    )
    VALUES (
        p_share_type,
        p_entity_id,
        COALESCE(p_user_id, auth.uid()),
        p_device_type,
        p_share_method
    )
    RETURNING id INTO v_share_id;
    
    RETURN v_share_id;
EXCEPTION
    WHEN OTHERS THEN
        RETURN NULL;
END;
$$;
```

### ุงูุฎุทูุฉ 4: ุฅุถุงูุฉ ุนููุฏ ุงูุนุฏุงุฏ

```sql
-- ุฅุถุงูุฉ ุนููุฏ share_count ูู ุฌุฏูู ุงูููุชุฌุงุช
ALTER TABLE public.products
ADD COLUMN IF NOT EXISTS share_count INTEGER DEFAULT 0;

-- ุฅุถุงูุฉ ุนููุฏ share_count ูู ุฌุฏูู ุงููุชุงุฌุฑ
ALTER TABLE public.vendors
ADD COLUMN IF NOT EXISTS share_count INTEGER DEFAULT 0;

-- ููุงุฑุณ
CREATE INDEX idx_products_share_count ON public.products(share_count DESC);
CREATE INDEX idx_vendors_share_count ON public.vendors(share_count DESC);
```

### ุงูุฎุทูุฉ 5: ุฅูุดุงุก Trigger ููุชุญุฏูุซ ุงูุชููุงุฆู

```sql
-- ุฏุงูุฉ ุชุญุฏูุซ ุงูุนุฏุงุฏ
CREATE OR REPLACE FUNCTION public.update_share_count()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
    IF NEW.share_type = 'product' THEN
        UPDATE public.products
        SET share_count = share_count + 1
        WHERE id = NEW.entity_id;
    ELSIF NEW.share_type = 'vendor' THEN
        UPDATE public.vendors
        SET share_count = share_count + 1
        WHERE id = NEW.entity_id;
    END IF;
    
    RETURN NEW;
END;
$$;

-- Trigger
CREATE TRIGGER trigger_update_share_count
AFTER INSERT ON public.shares
FOR EACH ROW
EXECUTE FUNCTION public.update_share_count();
```

---

## โ ุทุฑููุฉ ุณููุฉ: ุชูููุฐ ุณูุฑูุจุช ูุงุญุฏ

ุจุฏูุงู ูู ุชูููุฐ ูู ุฎุทูุฉ ุนูู ุญุฏุฉุ ููููู:

1. ุงูุชุญ ููู `setup_share_system_supabase.sql`
2. ุงูุณุฎ **ูู** ูุญุชููุงุชู
3. ุงูุตูู ูู **SQL Editor** ูู Supabase
4. ุงุถุบุท **Run**
5. ุงูุชุธุฑ ุญุชู ุชุฑู: โ ุชู ุฅุนุฏุงุฏ ูุธุงู ุงููุดุงุฑูุฉ ุจูุฌุงุญ!

---

## ๐ฑ ุงูุชุญุฏูุซุงุช ุงููุทููุจุฉ ูู Flutter

### ุชุญุฏูุซ share_services.dart

ุงูููู ุงูุญุงูู ูุณุชุฎุฏู Firebase URLs. ูู ุจุชุญุฏูุซู ููุง ููู:

#### ูุจู (Firebase):
```dart
final link = Uri.parse("https://istorto.com/product/${product.id}");
// ุงููุดุงุฑูุฉ ูุจุงุดุฑุฉ ุจุฏูู ุชุณุฌูู
```

#### ุจุนุฏ (Supabase):
```dart
// 1. ุชุณุฌูู ุงููุดุงุฑูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
await _logShare('product', product.id);

// 2. ุงููุดุงุฑูุฉ
final link = Uri.parse("https://istorto.com/product/${product.id}");
await Share.shareXFiles([image], text: message);

// 3. ุชุญุฏูุซ ุงูุนุฏุงุฏ
await _incrementShareCount('product', product.id);
```

### ุฅุถุงูุฉ ุฏูุงู ุฌุฏูุฏุฉ

ุฃุถู ูุฐู ุงูุฏูุงู ูู ููุงูุฉ ููู `share_services.dart`:

```dart
// ุชุณุฌูู ุงููุดุงุฑูุฉ
static Future<void> _logShare(String shareType, String entityId) async {
  try {
    final authController = Get.find<AuthController>();
    final userId = authController.currentUser.value?.userId;

    await SupabaseService.client.rpc('log_share', params: {
      'p_share_type': shareType,
      'p_entity_id': entityId,
      'p_user_id': userId,
      'p_device_type': Platform.operatingSystem,
      'p_share_method': 'share_plus',
    });
  } catch (e) {
    debugPrint('โ๏ธ Failed to log share: $e');
  }
}

// ุชุญุฏูุซ ุงูุนุฏุงุฏ
static Future<void> _incrementShareCount(String shareType, String entityId) async {
  try {
    if (shareType == 'product') {
      await SupabaseService.client
          .from('products')
          .update({'share_count': 1})
          .eq('id', entityId);
    } else if (shareType == 'vendor') {
      await SupabaseService.client
          .from('vendors')
          .update({'share_count': 1})
          .eq('id', entityId);
    }
  } catch (e) {
    debugPrint('โ๏ธ Failed to increment share count: $e');
  }
}

// ุงูุญุตูู ุนูู ุนุฏุฏ ุงููุดุงุฑูุงุช
static Future<int> getProductShareCount(String productId) async {
  try {
    final result = await SupabaseService.client
        .rpc('get_share_count', params: {
          'p_share_type': 'product',
          'p_entity_id': productId,
        });
    return result as int? ?? 0;
  } catch (e) {
    return 0;
  }
}
```

### ุงุณุชูุฑุงุฏ ุงูููุชุจุงุช ุงููุทููุจุฉ

ุฃุถู ูู ุจุฏุงูุฉ ุงูููู:

```dart
import 'dart:io';
import 'package:get/get.dart';
import 'package:istoreto/controllers/auth_controller.dart';
import 'package:istoreto/services/supabase_service.dart';
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### 1. ุงุฎุชุจุงุฑ ูู Supabase

```sql
-- ุงุฎุชุจุงุฑ ุชุณุฌูู ูุดุงุฑูุฉ
SELECT public.log_share('product', 'test-123', NULL, 'android', 'test');

-- ุงุฎุชุจุงุฑ ุงูุญุตูู ุนูู ุงูุนุฏุฏ
SELECT public.get_share_count('product', 'test-123');

-- ุนุฑุถ ุฌููุน ุงููุดุงุฑูุงุช
SELECT * FROM public.shares ORDER BY shared_at DESC LIMIT 5;
```

### 2. ุงุฎุชุจุงุฑ ูู Flutter

```dart
// ูู ุฃู ููุงู ูู ุงูุชุทุจูู
try {
  await ShareServices.shareProduct(product);
  print('โ ุงููุดุงุฑูุฉ ูุฌุญุช!');
} catch (e) {
  print('โ ูุดูุช ุงููุดุงุฑูุฉ: $e');
}
```

---

## ๐ ูููุฒุงุช ุฅุถุงููุฉ

### ุนุฑุถ ุนุฏุฏ ุงููุดุงุฑูุงุช ูู ุจุทุงูุฉ ุงูููุชุฌ

```dart
FutureBuilder<int>(
  future: ShareServices.getProductShareCount(product.id),
  builder: (context, snapshot) {
    if (snapshot.hasData && snapshot.data! > 0) {
      return Row(
        children: [
          Icon(Icons.share, size: 16),
          SizedBox(width: 4),
          Text('${snapshot.data} ูุดุงุฑูุฉ'),
        ],
      );
    }
    return SizedBox.shrink();
  },
)
```

### ุตูุญุฉ ุฃูุซุฑ ุงูููุชุฌุงุช ูุดุงุฑูุฉ

```dart
// ูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ ุฃู ูุณู ุฎุงุต
FutureBuilder<List<Map<String, dynamic>>>(
  future: ShareServices.getMostSharedProducts(limit: 10),
  builder: (context, snapshot) {
    if (!snapshot.hasData) return CircularProgressIndicator();
    
    return ListView.builder(
      itemCount: snapshot.data!.length,
      itemBuilder: (context, index) {
        final item = snapshot.data![index];
        return ListTile(
          title: Text('Product: ${item['product_id']}'),
          subtitle: Text('${item['share_count']} ูุดุงุฑูุฉ'),
        );
      },
    );
  },
)
```

---

## ๐ฏ ููุฎุต ุงูุฎุทูุงุช

### ูู Supabase (5 ุฏูุงุฆู):
1. โ ููุฐ `setup_share_system_supabase.sql`
2. โ ุชุญูู ูู ุฅูุดุงุก ุงูุฌุฏูู ูุงูุฏูุงู
3. โ ููุฐ ุงุฎุชุจุงุฑุงุช ูู `test_share_system_supabase.sql`

### ูู Flutter (10 ุฏูุงุฆู):
1. โ ุญุฏูุซ `share_services.dart`
2. โ ุฃุถู ุงูุฏูุงู ุงูุฌุฏูุฏุฉ
3. โ ุงุฎุชุจุฑ ุงููุดุงุฑูุฉ

### ุงููุชูุฌุฉ:
โ ูุธุงู ูุดุงุฑูุฉ ุงุญุชุฑุงูู ูุนูู ุจุงููุงูู!
โ ุชุชุจุน ุฏููู ูุฌููุน ุงููุดุงุฑูุงุช
โ ุฅุญุตุงุฆูุงุช ูุชุญูููุงุช ูุชูุฏูุฉ
โ ุนุฏุงุฏุงุช ุชููุงุฆูุฉ ูููุดุงุฑูุงุช

---

## ๐ ุงููููุงุช ุงููุฑููุฉ

1. **setup_share_system_supabase.sql** - ุงูุณูุฑูุจุช ุงูุฑุฆูุณู
2. **test_share_system_supabase.sql** - ุงุฎุชุจุงุฑุงุช ุดุงููุฉ
3. **SUPABASE_SHARE_SYSTEM_SETUP.md** - ุงูุฏููู ุงูุดุงูู ุจุงูุฅูุฌููุฒูุฉ
4. **QUICK_START_SHARE_SYSTEM.md** - ุฏููู ุงูุจุฏุงูุฉ ุงูุณุฑูุนุฉ
5. **ุฎุทูุงุช_ุฅุนุฏุงุฏ_ูุธุงู_ุงููุดุงุฑูุฉ.md** - ูุฐุง ุงูููู

---

## โ ุฃุณุฆูุฉ ุดุงุฆุนุฉ

### ุณ: ูู ุฃุญุชุงุฌ ูุญุฐู ุฃู ุดูุก ูู Firebaseุ
ุฌ: ูุงุ ุงููุธุงู ุงูุฌุฏูุฏ ูุณุชูู ุชูุงูุงู.

### ุณ: ูู ุณุชุชุฃุซุฑ ุงููุดุงุฑูุงุช ุงูููุฌูุฏุฉุ
ุฌ: ูุงุ ุงููุดุงุฑูุงุช ุงููุฏููุฉ ุณุชุจูู ุชุนููุ ูุงูุฌุฏูุฏุฉ ุณุชูุณุฌู ูู Supabase.

### ุณ: ูู ูู ุงูููุช ูุณุชุบุฑู ุงูุฅุนุฏุงุฏุ
ุฌ: 10-15 ุฏูููุฉ (5 ุฏูุงุฆู ูู SQL + 10 ุฏูุงุฆู ูู Flutter).

### ุณ: ูู ุงููุธุงู ุขููุ
ุฌ: ูุนู! ูุณุชุฎุฏู RLS Policies ู SECURITY DEFINER functions.

### ุณ: ูู ูููู ุชุชุจุน ุฅุญุตุงุฆูุงุช ุงููุดุงุฑูุฉุ
ุฌ: ูุนู! ูุฏูู Views ุฌุงูุฒุฉ ูุนุฑุถ ุฃูุซุฑ ุงูููุชุฌุงุช ูุงููุชุงุฌุฑ ูุดุงุฑูุฉ.

---

## ๐ ุงููุณุงุนุฏุฉ

ุฅุฐุง ูุงุฌูุช ูุดููุฉ:

1. ุชุญูู ูู [SUPABASE_SHARE_SYSTEM_SETUP.md](./SUPABASE_SHARE_SYSTEM_SETUP.md) - ูุณู Troubleshooting
2. ุฑุงุฌุน [test_share_system_supabase.sql](./test_share_system_supabase.sql) - ููุชุฃูุฏ ูู ุนูู ุงูุฏูุงู
3. ุงูุญุต Supabase Logs ูู Dashboard โ Logs

---

## ๐ ุชูุงูููุง!

ุจุนุฏ ุชุทุจูู ูุฐู ุงูุฎุทูุงุชุ ุณูููู ูุฏูู:
- โ ูุธุงู ูุดุงุฑูุฉ ุงุญุชุฑุงูู
- โ ุชุชุจุน ุฏููู ูููุดุงุฑูุงุช
- โ ุฅุญุตุงุฆูุงุช ูุชูุฏูุฉ
- โ ุนุฏุงุฏุงุช ุชููุงุฆูุฉ
- โ ุฃูุงู ุนุงูู

**ูุธุงู ุงููุดุงุฑูุฉ ุฌุงูุฒ ููุนูู ูุน Supabase! ๐**

