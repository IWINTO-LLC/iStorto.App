# خطوات إعداد نظام المشاركة مع Supabase
## تحويل نظام المشاركة من Firebase إلى Supabase

---

## 📋 نظرة عامة

نظام المشاركة الخاص بك يعمل حالياً مع روابط Firebase. للتحويل إلى Supabase، نحتاج إلى:
1. إنشاء جداول لتتبع المشاركات
2. إعداد دوال وسياسات الأمان
3. تحديث كود Flutter

---

## 🎯 الخطوات المطلوبة في قاعدة البيانات

### الخطوة 1: إنشاء جدول المشاركات

افتح **Supabase Dashboard** → **SQL Editor** → **New Query**

```sql
-- إنشاء جدول لتتبع المشاركات
CREATE TABLE public.shares (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    share_type TEXT NOT NULL CHECK (share_type IN ('product', 'vendor')),
    entity_id TEXT NOT NULL,
    user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
    shared_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    device_type TEXT,
    share_method TEXT
);

-- الفهارس للأداء
CREATE INDEX idx_shares_entity ON public.shares(share_type, entity_id);
CREATE INDEX idx_shares_user ON public.shares(user_id);
CREATE INDEX idx_shares_date ON public.shares(shared_at DESC);
```

### الخطوة 2: إعداد الأمان (RLS)

```sql
-- تفعيل Row Level Security
ALTER TABLE public.shares ENABLE ROW LEVEL SECURITY;

-- السماح للجميع بقراءة الإحصائيات
CREATE POLICY "Allow public read access"
ON public.shares FOR SELECT TO public USING (true);

-- السماح للمستخدمين بإضافة مشاركات
CREATE POLICY "Allow authenticated insert"
ON public.shares FOR INSERT TO authenticated
WITH CHECK (auth.uid() = user_id OR user_id IS NULL);
```

### الخطوة 3: إنشاء دالة تسجيل المشاركة

```sql
CREATE OR REPLACE FUNCTION public.log_share(
    p_share_type TEXT,
    p_entity_id TEXT,
    p_user_id UUID DEFAULT NULL,
    p_device_type TEXT DEFAULT NULL,
    p_share_method TEXT DEFAULT NULL
)
RETURNS UUID
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    v_share_id UUID;
BEGIN
    INSERT INTO public.shares (
        share_type,
        entity_id,
        user_id,
        device_type,
        share_method
    )
    VALUES (
        p_share_type,
        p_entity_id,
        COALESCE(p_user_id, auth.uid()),
        p_device_type,
        p_share_method
    )
    RETURNING id INTO v_share_id;
    
    RETURN v_share_id;
EXCEPTION
    WHEN OTHERS THEN
        RETURN NULL;
END;
$$;
```

### الخطوة 4: إضافة عمود العداد

```sql
-- إضافة عمود share_count في جدول المنتجات
ALTER TABLE public.products
ADD COLUMN IF NOT EXISTS share_count INTEGER DEFAULT 0;

-- إضافة عمود share_count في جدول المتاجر
ALTER TABLE public.vendors
ADD COLUMN IF NOT EXISTS share_count INTEGER DEFAULT 0;

-- فهارس
CREATE INDEX idx_products_share_count ON public.products(share_count DESC);
CREATE INDEX idx_vendors_share_count ON public.vendors(share_count DESC);
```

### الخطوة 5: إنشاء Trigger للتحديث التلقائي

```sql
-- دالة تحديث العداد
CREATE OR REPLACE FUNCTION public.update_share_count()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
    IF NEW.share_type = 'product' THEN
        UPDATE public.products
        SET share_count = share_count + 1
        WHERE id = NEW.entity_id;
    ELSIF NEW.share_type = 'vendor' THEN
        UPDATE public.vendors
        SET share_count = share_count + 1
        WHERE id = NEW.entity_id;
    END IF;
    
    RETURN NEW;
END;
$$;

-- Trigger
CREATE TRIGGER trigger_update_share_count
AFTER INSERT ON public.shares
FOR EACH ROW
EXECUTE FUNCTION public.update_share_count();
```

---

## ✅ طريقة سهلة: تنفيذ سكريبت واحد

بدلاً من تنفيذ كل خطوة على حدة، يمكنك:

1. افتح ملف `setup_share_system_supabase.sql`
2. انسخ **كل** محتوياته
3. الصقه في **SQL Editor** في Supabase
4. اضغط **Run**
5. انتظر حتى ترى: ✅ تم إعداد نظام المشاركة بنجاح!

---

## 📱 التحديثات المطلوبة في Flutter

### تحديث share_services.dart

الملف الحالي يستخدم Firebase URLs. قم بتحديثه كما يلي:

#### قبل (Firebase):
```dart
final link = Uri.parse("https://istorto.com/product/${product.id}");
// المشاركة مباشرة بدون تسجيل
```

#### بعد (Supabase):
```dart
// 1. تسجيل المشاركة في قاعدة البيانات
await _logShare('product', product.id);

// 2. المشاركة
final link = Uri.parse("https://istorto.com/product/${product.id}");
await Share.shareXFiles([image], text: message);

// 3. تحديث العداد
await _incrementShareCount('product', product.id);
```

### إضافة دوال جديدة

أضف هذه الدوال في نهاية ملف `share_services.dart`:

```dart
// تسجيل المشاركة
static Future<void> _logShare(String shareType, String entityId) async {
  try {
    final authController = Get.find<AuthController>();
    final userId = authController.currentUser.value?.userId;

    await SupabaseService.client.rpc('log_share', params: {
      'p_share_type': shareType,
      'p_entity_id': entityId,
      'p_user_id': userId,
      'p_device_type': Platform.operatingSystem,
      'p_share_method': 'share_plus',
    });
  } catch (e) {
    debugPrint('⚠️ Failed to log share: $e');
  }
}

// تحديث العداد
static Future<void> _incrementShareCount(String shareType, String entityId) async {
  try {
    if (shareType == 'product') {
      await SupabaseService.client
          .from('products')
          .update({'share_count': 1})
          .eq('id', entityId);
    } else if (shareType == 'vendor') {
      await SupabaseService.client
          .from('vendors')
          .update({'share_count': 1})
          .eq('id', entityId);
    }
  } catch (e) {
    debugPrint('⚠️ Failed to increment share count: $e');
  }
}

// الحصول على عدد المشاركات
static Future<int> getProductShareCount(String productId) async {
  try {
    final result = await SupabaseService.client
        .rpc('get_share_count', params: {
          'p_share_type': 'product',
          'p_entity_id': productId,
        });
    return result as int? ?? 0;
  } catch (e) {
    return 0;
  }
}
```

### استيراد المكتبات المطلوبة

أضف في بداية الملف:

```dart
import 'dart:io';
import 'package:get/get.dart';
import 'package:istoreto/controllers/auth_controller.dart';
import 'package:istoreto/services/supabase_service.dart';
```

---

## 🧪 الاختبار

### 1. اختبار في Supabase

```sql
-- اختبار تسجيل مشاركة
SELECT public.log_share('product', 'test-123', NULL, 'android', 'test');

-- اختبار الحصول على العدد
SELECT public.get_share_count('product', 'test-123');

-- عرض جميع المشاركات
SELECT * FROM public.shares ORDER BY shared_at DESC LIMIT 5;
```

### 2. اختبار في Flutter

```dart
// في أي مكان في التطبيق
try {
  await ShareServices.shareProduct(product);
  print('✅ المشاركة نجحت!');
} catch (e) {
  print('❌ فشلت المشاركة: $e');
}
```

---

## 📊 مميزات إضافية

### عرض عدد المشاركات في بطاقة المنتج

```dart
FutureBuilder<int>(
  future: ShareServices.getProductShareCount(product.id),
  builder: (context, snapshot) {
    if (snapshot.hasData && snapshot.data! > 0) {
      return Row(
        children: [
          Icon(Icons.share, size: 16),
          SizedBox(width: 4),
          Text('${snapshot.data} مشاركة'),
        ],
      );
    }
    return SizedBox.shrink();
  },
)
```

### صفحة أكثر المنتجات مشاركة

```dart
// في الصفحة الرئيسية أو قسم خاص
FutureBuilder<List<Map<String, dynamic>>>(
  future: ShareServices.getMostSharedProducts(limit: 10),
  builder: (context, snapshot) {
    if (!snapshot.hasData) return CircularProgressIndicator();
    
    return ListView.builder(
      itemCount: snapshot.data!.length,
      itemBuilder: (context, index) {
        final item = snapshot.data![index];
        return ListTile(
          title: Text('Product: ${item['product_id']}'),
          subtitle: Text('${item['share_count']} مشاركة'),
        );
      },
    );
  },
)
```

---

## 🎯 ملخص الخطوات

### في Supabase (5 دقائق):
1. ✅ نفذ `setup_share_system_supabase.sql`
2. ✅ تحقق من إنشاء الجدول والدوال
3. ✅ نفذ اختبارات من `test_share_system_supabase.sql`

### في Flutter (10 دقائق):
1. ✅ حدّث `share_services.dart`
2. ✅ أضف الدوال الجديدة
3. ✅ اختبر المشاركة

### النتيجة:
✅ نظام مشاركة احترافي يعمل بالكامل!
✅ تتبع دقيق لجميع المشاركات
✅ إحصائيات وتحليلات متقدمة
✅ عدادات تلقائية للمشاركات

---

## 📚 الملفات المرفقة

1. **setup_share_system_supabase.sql** - السكريبت الرئيسي
2. **test_share_system_supabase.sql** - اختبارات شاملة
3. **SUPABASE_SHARE_SYSTEM_SETUP.md** - الدليل الشامل بالإنجليزية
4. **QUICK_START_SHARE_SYSTEM.md** - دليل البداية السريعة
5. **خطوات_إعداد_نظام_المشاركة.md** - هذا الملف

---

## ❓ أسئلة شائعة

### س: هل أحتاج لحذف أي شيء من Firebase؟
ج: لا، النظام الجديد مستقل تماماً.

### س: هل ستتأثر المشاركات الموجودة؟
ج: لا، المشاركات القديمة ستبقى تعمل، والجديدة ستُسجل في Supabase.

### س: كم من الوقت يستغرق الإعداد؟
ج: 10-15 دقيقة (5 دقائق لـ SQL + 10 دقائق لـ Flutter).

### س: هل النظام آمن؟
ج: نعم! نستخدم RLS Policies و SECURITY DEFINER functions.

### س: هل يمكن تتبع إحصائيات المشاركة؟
ج: نعم! لديك Views جاهزة لعرض أكثر المنتجات والمتاجر مشاركة.

---

## 🆘 المساعدة

إذا واجهت مشكلة:

1. تحقق من [SUPABASE_SHARE_SYSTEM_SETUP.md](./SUPABASE_SHARE_SYSTEM_SETUP.md) - قسم Troubleshooting
2. راجع [test_share_system_supabase.sql](./test_share_system_supabase.sql) - للتأكد من عمل الدوال
3. افحص Supabase Logs في Dashboard → Logs

---

## 🎉 تهانينا!

بعد تطبيق هذه الخطوات، سيكون لديك:
- ✅ نظام مشاركة احترافي
- ✅ تتبع دقيق للمشاركات
- ✅ إحصائيات متقدمة
- ✅ عدادات تلقائية
- ✅ أمان عالي

**نظام المشاركة جاهز للعمل مع Supabase! 🚀**

